# 2023-03 another healthcheck

## 1 The main idea

The project was generated by this scenario:  
I just deployed a service in a new infrastructure  

```text
Hey service! are you ok?
```

Usually we call the `healthcheck` or the `verison` URL.  
The usual implementaion for `healthcheck` needs to be very fast without details: the service is alive! But this information is **very limited** in scope.  
You are alive, but are you operational? Can you read the bucket?

I want to go a bit more in depth:  
I want to kwon if the service is **_fully operational in its environment_**

```text
Hey service!
Can you do what you need to do?
Can you complete your tasks?
Can you talk with your friends?
Are you well configured in your environment?
Are you full operational?
```

## 2. Requirements

- Every service respond with a common JSON structure
- It is fast to implement a new check in every project

### 2.1 Response example - simple

`GET /another_healthcheck`

```json
{
    "service_status": "OK",  // "KO"
    "service_name": "service-name",
    "container_id": "?something-that-represents-the-container?",
    "checks_summary":{
        "dur_ms": 42.42,
        "count": 12,
        "ko_count": 0,  // 2
        "ko_names": [],  // ["foo-check", "bar-check"], 
    }
}
```

Each simple response contains:

- global OK/KO
- service and container identifier
- summary
  - timing
  - count of performed checks
  - count of ko checks
  - names of ko checks

### 2.2 Response example - details

`GET /another_healthcheck?details`

```json
{
    "service_status": "KO",
    "service_name": "service-name",
    "container_id": "?something-that-represents-the-container?",
    "checks_summary":{ ... summary ... },
    "checks_details":[
        { ... details for one check ... },
        { ... details for one check ... },
        { ... details for one check ... },
        { ... details for one check ... }
    ]

}
```

Each check detail provides:

- OK/KO
- timing
- name
- description
- custom details

```json
// sample of details for one check
        {
            "check_status": "OK",
            "check_dur_ms": 42.42,
            "check_name": "lorem-ipsum",
            "check_desc": "Lorem ipsum dolor sit amet",
            "check_details": {
                "one": "info one",
                "foo": "info foo",
                "bar": "info bar",
            },
        }

```

## 3. Checks to perform

Every service has different contact points with other systems.

Typical dependencies are:

- s3
- db (sql, nosql, ...)
- internal http services
- external http services
- ...

I can perform various types of check to verify capabilities of the service.  

It can read a resource (s3 file, db row, http get...)  
It can write a resource only when it is harmless or rollback-able  

I can call the same healthcheck on other internal services (beware of recursive recall)

## Which will be the name for this module?

```text
- long                     (short, ...)

- heavy healthcheck        (hh, h-hc)
- fat healthcheck          (fh, f-hc)
- op healthcheck           (oph, op-hc)
- operational healthcheck  (oph, op-hc)
- complete healthcheck     (ch, c-hc)
- advanced healthcheck     (ah, a-hc)
- deep status              (ds, dest)
- ...
```

## guidelines

- implement in small slices
- unit tests are mandatory (maybe test first)

### sample service

GIT: `https://github.com/mailupinc/bee-deadcodepool`

```bash

curl https://pre-bee-deadcodepool.getbee.info/healthcheck                | jq
curl https://pre-bee-deadcodepool.getbee.info/version                    | jq
curl https://pre-bee-deadcodepool.getbee.info/deadcodepool/feature_one   | jq
curl https://pre-bee-deadcodepool.getbee.info/heavy_healthcheck          | jq

```
